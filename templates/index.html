<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Pulse - An√°lise de Extremos em Tempo Real</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --card: #0f1724;
      --muted: #94a3b8;
      --accent: #3b82f6;
      --green: #22c55e;
      --red: #ef4444;
      --orange: #f59e0b;
      --yellow: #eab308;
    }
    html,body { height: 100%; margin: 0; font-family: Inter, system-ui, Arial; background: var(--bg); color: #e6eef6; }
    .container { max-width: 1800px; margin: 18px auto; padding: 16px; }
    h1 { margin: 0 0 14px 0; color: #9ae6b4; }
    .subtitulo { 
      margin: 0 0 20px 0; 
      color: var(--muted); 
      font-size: 14px; 
      font-style: italic;
      border-left: 3px solid var(--accent);
      padding-left: 10px;
    }
    
    /* Controles principais */
    .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
    .view-toggle { display: flex; background: var(--card); border-radius: 8px; padding: 4px; }
    .view-toggle button { 
      padding: 8px 16px; 
      border: none; 
      background: transparent; 
      color: var(--muted); 
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .view-toggle button.active { 
      background: var(--accent); 
      color: white; 
    }
    
    .coin-categories { display: flex; gap: 18px; margin-bottom: 18px; flex-wrap: wrap; }
    .category { background: var(--card); padding: 12px; border-radius: 10px; flex: 1; min-width: 300px; }
    .category h3 { margin: 0 0 10px 0; color: var(--muted); font-size: 14px; text-transform: uppercase; }
    .checkboxes { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; }
    .checkboxes label { display: flex; align-items: center; font-size: 13px; cursor: pointer; }
    .checkboxes input { margin-right: 6px; }

    /* Tabela */
    table { width: 100%; border-collapse: collapse; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius: 8px; overflow: hidden; font-size: 13px; }
    th, td { padding: 10px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.03); }
    thead th { background: rgba(255,255,255,0.02); color: var(--muted); text-transform: uppercase; font-size: 11px; }
    tbody tr:hover { background: rgba(255,255,255,0.02); }
    tbody tr { cursor: pointer; transition: background-color 0.2s; }
    tbody tr.active { background: rgba(59, 130, 246, 0.1); }

    /* Gr√°ficos */
    .charts-container { 
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); 
      gap: 20px; 
      margin-bottom: 20px;
    }
    .charts-container.active { display: grid; }
    .chart-card { 
      background: var(--card); 
      padding: 15px; 
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .chart-header { 
      display: flex; 
      justify-content: between; 
      align-items: center; 
      margin-bottom: 10px;
    }
    .chart-title { 
      font-size: 14px; 
      font-weight: bold; 
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .chart-controls { display: flex; gap: 10px; }
    .chart-controls button { 
      padding: 4px 8px; 
      font-size: 11px; 
      background: rgba(255,255,255,0.1); 
      border: none; 
      border-radius: 4px; 
      color: var(--muted);
      cursor: pointer;
    }
    .chart-controls button.active { background: var(--accent); color: white; }
    .chart-wrapper { position: relative; height: 250px; }

    /* Estados visuais */
    .green { color: var(--green); }
    .red { color: var(--red); }
    .rsi-high { color: var(--red); font-weight: bold; }
    .rsi-low { color: var(--green); font-weight: bold; }
    .rsi-normal { color: var(--muted); }
    .rsi-neutral { color: var(--orange); }

    .proximity-cell { font-size: 16px; text-align: center; font-weight: bold; }
    .proximity-green { color: var(--green); }
    .proximity-yellow { color: var(--yellow); }
    .proximity-red { color: var(--red); }
    .proximity-black { color: var(--muted); }

    .legend { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; font-size: 11px; color: var(--muted); }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-section { display: flex; gap: 15px; margin-right: 20px; }

    .loading { text-align: center; color: var(--muted); padding: 20px; }

    /* Responsividade */
    @media (max-width: 1200px) {
      .container { max-width: 100%; padding: 10px; }
      table { font-size: 11px; }
      th, td { padding: 6px 3px; }
      .proximity-cell { font-size: 14px; }
      .subtitulo { font-size: 12px; }
      .charts-container { grid-template-columns: 1fr; }
      .chart-card { min-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä Crypto Pulse - An√°lise de Extremos em Tempo Real</h1>
    
    <p class="subtitulo">
      P√°gina desenvolvida pelo engenheiro da computa√ß√£o: Vin√≠cius Werneck. 
      E-mail: viniciusonrj@gmail.com
    </p>

    <!-- Controles de visualiza√ß√£o -->
    <div class="controls">
      <div class="view-toggle">
        <button id="view-table" class="active">üìã Visualiza√ß√£o em Tabela</button>
        <button id="view-charts">üìà Gr√°ficos Di√°rios</button>
      </div>
    </div>

    <div class="legend">
      <div class="legend-section">
        <div class="legend-item"><span class="proximity-red">üî¥</span> Perto da M√ÅXIMA</div>
        <div class="legend-item"><span class="proximity-green">üü¢</span> Perto da M√çNIMA</div>
        <div class="legend-item"><span class="proximity-yellow">üü°</span> Dist√¢ncia m√©dia</div>
      </div>
      <div class="legend-section">
        <div class="legend-item"><span class="proximity-green">üü¢</span> Longe da M√ÅXIMA</div>
        <div class="legend-item"><span class="proximity-red">üî¥</span> Longe da M√çNIMA</div>
        <div class="legend-item"><span class="proximity-black">‚ö´</span> Sem dados</div>
      </div>
    </div>

    <!-- Container dos gr√°ficos -->
    <div id="charts-container" class="charts-container"></div>

    <!-- Tabela de pre√ßos -->
    <div id="table-container">
      <div class="coin-categories">
        <div class="category">
          <h3>üí∞ Principais</h3>
          <div class="checkboxes" id="main-coins-selector"></div>
        </div>
        
        <div class="category">
          <h3>üöÄ Altcoins</h3>
          <div class="checkboxes" id="altcoins-selector"></div>
        </div>
        
        <div class="category">
          <h3>üé™ Shitcoins</h3>
          <div class="checkboxes" id="shitcoins-selector"></div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Moeda</th>
            <th>Pre√ßo (USDT)</th>
            <th>Varia√ß√£o 24h</th>
            <th>RSI Di√°rio</th>
            <th>M√°x. Semanal</th>
            <th>M√≠n. Semanal</th>
            <th>M√°x. Mensal</th>
            <th>M√≠n. Mensal</th>
          </tr>
        </thead>
        <tbody id="price-table">
          <tr><td colspan="8" class="loading">Carregando dados...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
  const MAIN_COINS = {{ main_coins|tojson }};
  const ALTCOINS = {{ altcoins|tojson }};
  const SHITCOINS = {{ shitcoins|tojson }};
  
  let selectedSymbols = [...MAIN_COINS];
  let currentCharts = new Map(); // Armazena inst√¢ncias dos gr√°ficos
  let currentView = 'table'; // 'table' ou 'charts'

  // Elementos DOM
  const viewTableBtn = document.getElementById('view-table');
  const viewChartsBtn = document.getElementById('view-charts');
  const chartsContainer = document.getElementById('charts-container');
  const tableContainer = document.getElementById('table-container');

  // Alternar entre visualiza√ß√µes
  viewTableBtn.addEventListener('click', () => switchView('table'));
  viewChartsBtn.addEventListener('click', () => switchView('charts'));

  function switchView(view) {
    currentView = view;
    
    // Atualizar bot√µes
    viewTableBtn.classList.toggle('active', view === 'table');
    viewChartsBtn.classList.toggle('active', view === 'charts');
    
    // Mostrar/ocultar containers
    tableContainer.style.display = view === 'table' ? 'block' : 'none';
    chartsContainer.classList.toggle('active', view === 'charts');
    
    if (view === 'charts') {
      renderCharts();
    }
  }

  // Renderizar seletores de moedas
  function renderCoinSelectors() {
    renderCategory('main-coins-selector', MAIN_COINS, 'main-');
    renderCategory('altcoins-selector', ALTCOINS, 'alt-');
    renderCategory('shitcoins-selector', SHITCOINS, 'shit-');
  }

  function renderCategory(containerId, coins, prefix) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    coins.forEach(sym => {
      const shortName = sym.replace('USDT', '');
      const id = `${prefix}${sym}`;
      const checked = selectedSymbols.includes(sym) ? 'checked' : '';
      
      container.innerHTML += `
        <label>
          <input type="checkbox" id="${id}" value="${sym}" ${checked}>
          ${shortName}
        </label>
      `;
    });

    coins.forEach(sym => {
      const el = document.getElementById(`${prefix}${sym}`);
      if (el) el.addEventListener('change', updateSelectedSymbols);
    });
  }

  function updateSelectedSymbols() {
    const allCheckboxes = document.querySelectorAll('.checkboxes input[type="checkbox"]');
    selectedSymbols = Array.from(allCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    
    loadPrices();
    if (currentView === 'charts') {
      renderCharts();
    }
  }

  // Fun√ß√µes auxiliares para RSI e formata√ß√£o
  function getRsiClass(rsiValue) {
    if (rsiValue === null || rsiValue === undefined) return 'rsi-normal';
    if (rsiValue >= 70) return 'rsi-high';
    if (rsiValue <= 30) return 'rsi-low';
    if (rsiValue >= 45 && rsiValue <= 55) return 'rsi-neutral';
    return 'rsi-normal';
  }

  function getProximityClass(proximityEmoji) {
    switch(proximityEmoji) {
      case 'üü¢': return 'proximity-green';
      case 'üü°': return 'proximity-yellow';
      case 'üî¥': return 'proximity-red';
      default: return 'proximity-black';
    }
  }

  function formatRsi(rsiValue) {
    if (rsiValue === null || rsiValue === undefined) return '-';
    return rsiValue.toFixed(1);
  }

  // Carregar dados de pre√ßos
  async function loadPrices() {
    if (selectedSymbols.length === 0) {
      document.getElementById("price-table").innerHTML = "<tr><td colspan='8'>Selecione pelo menos uma moeda</td></tr>";
      return;
    }
    
    const url = `/prices?symbols=${selectedSymbols.join(",")}`;
    
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      
      const data = await resp.json();
      renderPriceTable(data);
    } catch (err) {
      console.error("Erro ao carregar pre√ßos:", err);
      document.getElementById("price-table").innerHTML = `<tr><td colspan='8'>Erro ao carregar dados</td></tr>`;
    }
  }

  // Renderizar tabela de pre√ßos
  function renderPriceTable(data) {
    const tbody = document.getElementById("price-table");
    
    if (data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='8'>Nenhum dado dispon√≠vel</td></tr>";
      return;
    }
    
    // Ordenar dados
    data.sort((a, b) => {
      const order = { 'BTCUSDT': 1, 'ETHUSDT': 2, 'BNBUSDT': 3 };
      return (order[a.symbol] || 4) - (order[b.symbol] || 4) || a.symbol.localeCompare(b.symbol);
    });
    
    tbody.innerHTML = "";
    data.forEach(d => {
      const changeClass = d.change >= 0 ? "green" : "red";
      const rsiClass = getRsiClass(d.rsi);
      const weeklyHighClass = getProximityClass(d.weekly_high);
      const weeklyLowClass = getProximityClass(d.weekly_low);
      const monthlyHighClass = getProximityClass(d.monthly_high);
      const monthlyLowClass = getProximityClass(d.monthly_low);
      const shortName = d.symbol.replace('USDT', '');
      const rsiText = formatRsi(d.rsi);
      
      tbody.innerHTML += `
        <tr data-symbol="${d.symbol}" onclick="toggleChart('${d.symbol}')">
          <td><strong>${shortName}</strong></td>
          <td>${Number(d.price).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:8})}</td>
          <td class="${changeClass}"><strong>${Number(d.change).toFixed(2)}%</strong></td>
          <td class="${rsiClass}"><strong>${rsiText}</strong></td>
          <td class="proximity-cell ${weeklyHighClass}">${d.weekly_high}</td>
          <td class="proximity-cell ${weeklyLowClass}">${d.weekly_low}</td>
          <td class="proximity-cell ${monthlyHighClass}">${d.monthly_high}</td>
          <td class="proximity-cell ${monthlyLowClass}">${d.monthly_low}</td>
        </tr>
      `;
    });
  }

  // Fun√ß√£o para buscar dados do gr√°fico
  async function fetchChartData(symbol, interval = '1d', limit = 30) {
    try {
      const response = await fetch(`/chart-data?symbol=${symbol}&interval=${interval}&limit=${limit}`);
      if (!response.ok) throw new Error('Erro ao buscar dados do gr√°fico');
      return await response.json();
    } catch (error) {
      console.error('Erro fetching chart data:', error);
      return null;
    }
  }

  // Criar gr√°fico para uma moeda
  async function createChart(symbol, container) {
    const chartData = await fetchChartData(symbol);
    if (!chartData || !chartData.length) {
      container.innerHTML = '<div class="loading">Dados n√£o dispon√≠veis</div>';
      return null;
    }

    const ctx = document.createElement('canvas');
    container.innerHTML = '';
    container.appendChild(ctx);

    const prices = chartData.map(d => d.close);
    const dates = chartData.map(d => new Date(d.timestamp).toLocaleDateString());

    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: `Pre√ßo ${symbol.replace('USDT', '')} (USDT)`,
          data: prices,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            mode: 'index',
            intersect: false
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(255,255,255,0.05)'
            },
            ticks: {
              color: '#94a3b8',
              maxTicksLimit: 8
            }
          },
          y: {
            grid: {
              color: 'rgba(255,255,255,0.05)'
            },
            ticks: {
              color: '#94a3b8'
            }
          }
        }
      }
    });
  }

  // Renderizar todos os gr√°ficos
  async function renderCharts() {
    chartsContainer.innerHTML = '';
    currentCharts.clear();

    for (const symbol of selectedSymbols) {
      const chartCard = document.createElement('div');
      chartCard.className = 'chart-card';
      chartCard.innerHTML = `
        <div class="chart-header">
          <div class="chart-title">
            <span>${symbol.replace('USDT', '')}</span>
          </div>
          <div class="chart-controls">
            <button class="interval-btn active" data-interval="1d">1D</button>
            <button class="interval-btn" data-interval="1h">1H</button>
            <button class="interval-btn" data-interval="15m">15M</button>
          </div>
        </div>
        <div class="chart-wrapper" id="chart-${symbol}">
          <div class="loading">Carregando gr√°fico...</div>
        </div>
      `;
      
      chartsContainer.appendChild(chartCard);
      
      // Criar gr√°fico inicial
      const chartWrapper = chartCard.querySelector('.chart-wrapper');
      const chart = await createChart(symbol, chartWrapper);
      if (chart) {
        currentCharts.set(symbol, chart);
      }

      // Adicionar event listeners para os bot√µes de intervalo
      chartCard.querySelectorAll('.interval-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const interval = e.target.dataset.interval;
          
          // Atualizar bot√µes ativos
          chartCard.querySelectorAll('.interval-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          
          // Atualizar gr√°fico
          chartWrapper.innerHTML = '<div class="loading">Carregando...</div>';
          const newChart = await createChart(symbol, chartWrapper, interval);
          if (newChart) {
            currentCharts.set(symbol, newChart);
          }
        });
      });
    }
  }

  // Alternar visibilidade do gr√°fico individual
  function toggleChart(symbol) {
    const chartElement = document.getElementById(`chart-${symbol}`);
    if (chartElement) {
      chartElement.style.display = chartElement.style.display === 'none' ? 'block' : 'none';
    }
  }

  // Atualizar dados periodicamente
  setInterval(() => {
    loadPrices();
    if (currentView === 'charts') {
      // Atualizar gr√°ficos existentes
      currentCharts.forEach((chart, symbol) => {
        // Aqui voc√™ pode implementar a atualiza√ß√£o dos dados do gr√°fico
      });
    }
  }, 10000);

  // Inicializa√ß√£o
  document.addEventListener('DOMContentLoaded', () => {
    renderCoinSelectors();
    loadPrices();
  });

</script>
</body>
</html>